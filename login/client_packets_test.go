package login

import (
	"goTibia/protocol/crypto"
	"testing"

	"github.com/stretchr/testify/require"
)

func Test(t *testing.T) {
	// We want to use the known test RSA keys so we can decrypt the packet
	crypto.RSA.GameServerPublicKey = &crypto.RSA.ClientPrivateKey.PublicKey

	packet := ClientCredentialPacket{
		Protocol:      1,
		ClientOS:      65535,
		ClientVersion: 1234,
		DatSignature:  7,
		SprSignature:  8,
		PicSignature:  9,
		XTEAKey:       [4]uint32{17, 18, 19, 20},
		AccountNumber: 42,
		Password:      "secret",
	}

	marshal, err := packet.Marshal()
	require.NoError(t, err, "Marshalling login packet should not fail")

	loginPacket, err := ParseCredentialsPacket(marshal)
	require.NoError(t, err, "Failed to parse login packet")

	require.Equal(t, packet, *loginPacket, "Parsed packet does not match original")
}

func TestParseLoginPacket_GoldenSample(t *testing.T) {
	capturedPacket := []byte{
		0x01, 0x02, 0x00, 0x04, 0x03, 0x33, 0x5a, 0x9d, 0x43, 0xbe, 0x52, 0x98,
		0x43, 0xd8, 0xc8, 0x50, 0x44, 0x22, 0x4c, 0x47, 0x25, 0xbd, 0xe0, 0x21,
		0x8c, 0xfe, 0xa8, 0x8f, 0xb8, 0x22, 0x03, 0x89, 0x18, 0x73, 0xf7, 0xa6,
		0x56, 0x0e, 0x2b, 0x4a, 0x29, 0x1c, 0xa6, 0x31, 0x83, 0xa5, 0x28, 0x94,
		0x02, 0xc1, 0x10, 0x0b, 0x1b, 0x0b, 0x76, 0xa7, 0x67, 0x06, 0xca, 0x13,
		0x4d, 0x13, 0x93, 0xd9, 0xca, 0x32, 0xb5, 0xec, 0x7a, 0xe3, 0x5b, 0xb9,
		0xaa, 0x1d, 0x44, 0xba, 0x90, 0xdd, 0xb5, 0x18, 0x43, 0x16, 0xa9, 0x01,
		0xf3, 0x3a, 0x38, 0xc5, 0x97, 0xe9, 0xc2, 0x74, 0x71, 0xef, 0x27, 0xac,
		0xb4, 0x5c, 0xd1, 0x1b, 0xec, 0xbc, 0x28, 0x19, 0x31, 0x71, 0x44, 0xfa,
		0x45, 0x6f, 0xed, 0xeb, 0x56, 0x5f, 0xad, 0x21, 0x28, 0xa1, 0xb6, 0xd2,
		0x03, 0x88, 0x0e, 0xf4, 0x93, 0xe8, 0x44, 0xc7, 0x5c, 0x35, 0xac, 0xfd,
		0x0e, 0x74, 0x8a, 0xb2, 0xce, 0x39, 0x8b, 0xeb, 0xa3, 0xab, 0xfd, 0x0e,
		0x6d,
	}

	packet, err := ParseCredentialsPacket(capturedPacket)
	require.NoError(t, err, "Failed to parse login packet")

	expected := ClientCredentialPacket{
		Protocol:      1,
		ClientOS:      2,
		ClientVersion: 772,
		DatSignature:  0x439d5a33,
		SprSignature:  0x439852be,
		PicSignature:  0x4450c8d8,
		XTEAKey:       [4]uint32{0x5b662e94, 0xa6bad792, 0x2c425917, 0x510cf169},
		AccountNumber: 123,
		Password:      "baba",
	}
	require.Equal(t, expected, *packet)
}
